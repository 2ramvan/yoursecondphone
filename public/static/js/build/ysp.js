!function(){"use strict";angular.module("ysp-controllers",["ngSanitize"]).controller("ErrorCtrl",["$log","$scope","$routeParams","peer_server_port",function(a,b,c,d){function e(a){return"Your Second Phone is unable to communicate with the server. Make sure that your firewall isn't blocking access to port "+d+". These are important to Your Second Phone working. Or the server could be down, if this error keeps happening even after you check your firewall, please report it to <a href='https://twitter.com/home?status=@yoursecondphone%20I'm%20getting%20a%20%22"+a+"%22.%20Please%20help!' target='_blank'>@yoursecondphone</a>"}var f={"no-webcam":"Your Second Phone was denied access to the webcam!","server-error":e("server-error"),"browser-incompatible":'Your browser is not capable of making video calls, please use the latest version of <a target="_blank" href="https://www.google.com/chrome">Google Chrome</a>, <a target="_blank" href="https://www.mozilla.org/firefox">Firefox</a> or <a target="_blank" href="http://www.opera.com/">Opera</a>',"ssl-unavailable":"An error was encountered while attempting to establish a secure connection with the server.","socket-error":e("socket-error"),"socket-io-error":e("socket-io-error")};b.error_id=c.err_type,b.error_description=f[b.error_id]||"An unknown error has occured."}]).controller("RootCtrl",["$log","$scope","GumService","$random","$location","supportsRealTimeCommunication","coordinator","$timeout",function(a,b,c,d,e,f,g,h){b.current_step=0,b.current_step=f()?1:-1,b.room_name="",b.valid_room_name=!0,b.$watch("room_name",function(a){return""===a?void(b.valid_room_name=!0):void(b.valid_room_name=a.match(/^\w(\w|-){1,30}$/))}),b.loading_gum=!1,b.initGum=function(){b.loading_gum=!0,c.once("active",function(){b.current_step+=1,h(angular.noop)}),c.invoke()},b.loading_room=!1,b.error_message="",b.launchRoom=function(){b.loading_room=!0,a.debug("Launching room... %s",b.room_name),b.valid_room_name&&""!=b.room_name||(b.room_name=d.string(10)),g.room_exists(b.room_name,function(a){b.loading_room=!1,a?(b.error_message="Sorry, that room name is already taken.",h(angular.noop),h(function(){b.error_message=""},5e3)):(e.path("/"+b.room_name),h(angular.noop))})}}]).controller("RoomCtrl",["$timeout","$log","$scope","GumService","$location","$routeParams","coordinator","ApplicationError","PeerWrapper","peer","fullscreen","$random","$rootScope","supportsRealTimeCommunication",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){function o(a){c.messages.push(a),m.$broadcast("ysp:message")}return n()?(c.room_id=f.room_id,c.room_link="http://ysp.im/#/"+f.room_id,c.peers=[],c.messages=[],c.draft="",c.showMessages=!0,c.isFullscreen=!1,c.getNumPeers=function(){var a=["zero","one","two"];return a[c.peers.length]},c.getColumnSize=function(){var a=["large-12","large-12","large-6"];return a[c.peers.length]},c.goFullscreen=function(){k.request(document.querySelector("div#all-streams")),a(angular.noop)},c.sendMessage=function(){c.draft&&c.peers.length&&async.each(c.peers,function(a,b){a.send("message",c.draft),b(null)},function(){o({from:j.id,content:c.draft,time_received:new Date}),c.draft="",b.debug("Message sent!")})},$(document).on(k.raw.fullscreenchange,function(){a(angular.noop)}),m.$on("$routeChangeStart",function(){g.leave_room(f.room_id),g.removeAllListeners(),$(document).off(k.raw.fullscreenchange)}),c.$watch(function(){return k.isFullscreen},function(a){c.isFullscreen=a}),c.$on("peer:reconnect",function(){g.once("ready",function(){g.join_room(c.room_id)})}),void async.waterfall([function(a){async.parallel([function(a){return d.isInvoked()?a(null):(d.once("active",function(){return a(null)}),void d.invoke())},function(a){g.isReady()?a(null):g.once("ready",function(){a(null)})}],function(){a(null)})},function(a){g.join_room(c.room_id,a)}],function(d,e){function f(d){do d.color_code=n[l.integer(4)];while(_.contains(p,d.color_code));p.push(d.color_code),d.once("close",function(e){var f=p.indexOf(d.color_code);p.splice(f,1),b.debug("peer(%s) closed, pruning...",e),c.peers=c.peers.filter(function(a){return a.id!=e}),a(angular.noop)}),d.on("message",function(b){var e={};e.color_code=d.color_code,e.content=b,e.time_received=new Date,e.from=d.id,o(e),c.showMessages=!0,a(angular.noop)}),c.peers.push(d),a(angular.noop)}if(d)return new h(d);var k={},m={};j.on("call",function(a){if(m.hasOwnProperty(a.peer)){b.debug("mc(%s) arrived!",a.peer);var c=m[a.peer];delete m[a.peer];var d=i.forgeFromConnections(c,a);f(d)}else b.debug("mc(%s) received before dc, waiting...",a.peer),k[a.peer]=a}),j.on("connection",function(a){if(k.hasOwnProperty(a.peer)){b.debug("dc(%s) arrived!",a.peer);var c=k[a.peer];delete k[a.peer];var d=i.forgeFromConnections(a,c);f(d)}else b.debug("dc(%s) received before mc, waiting...",a.peer),m[a.peer]=a});var n=["green","blue","purple","orange","red"],p=[];g.on("peer_left",function(d){b.debug("[RoomCtrl] - coordinator said that (%s) left",d);var e=_.find(c.peers,{id:d});if(e){e.close();var f=p.indexOf(e.color_code);f>=0&&p.splice(f,1),c.peers=c.peers.filter(function(a){return a.id!=d}),b.debug("[RoomCtrl] - successfully removed %s",d)}a(angular.noop)}),e.forEach(function(a){var b=new i(a);f(b)})})):new h("browser-incompatible",!0)}])}(this),function(){"use strict";angular.module("ysp-directives",[]).directive("pinToBottom",["$log","$rootScope","$timeout",function(a,b,c){return{restrict:"C",link:function(a,d){d=d[0],b.$on("ysp:message",function(){c(function(){$(d).scrollTop(d.scrollHeight+200)},75)})}}}]).directive("peer",["$log",function(){return{restrict:"E",scope:{peer:"=info"},link:function(a,b){var c=b.children()[0];a.peer.ms?attachMediaStream(c,a.peer.ms):a.peer.once("stream",function(){attachMediaStream(c,a.peer.ms)})},template:"<video autoplay class='peer_window'></video><div class='peer_color' ng-class='peer.color_code'></div>"}}]).directive("mirror",["$log","GumService",function(a,b){return{restrict:"E",link:function(a,c){var d=c.children()[0];b.isInvoked()&&attachMediaStream(d,b.getMediaStream()),b.on("active",function(a){attachMediaStream(d,a),$(c).removeClass("inactive")}),b.on("inactive",function(){$(c).addClass("inactive")})},template:"<video autoplay id='mirror' muted='muted'></video><div class='cf'></div>"}}])}(this),function(a){"use strict";angular.module("ysp",["ysp-services","ysp-controllers","ysp-directives","ngRoute","ngSanitize"]).constant("main_host","yoursecondphone.co").constant("peer_server_port",8080).value("fullscreen",screenfull).config(["$logProvider",function(a){a.debugEnabled(!1)}]).config(["$routeProvider",function(a){a.when("/",{controller:"RootCtrl",templateUrl:"/static/views/root.html"}),a.when("/error/:err_type",{controller:"ErrorCtrl",templateUrl:"/static/views/error.html"}),a.when("/:room_id",{controller:"RoomCtrl",templateUrl:"/static/views/room.html"}),a.otherwise({redirectTo:"/"})}]).run(["$log","peer","coordinator","ApplicationError",function(a,b,c){b.open?c.advertise_peer_id():b.once("open",function(){c.advertise_peer_id()})}]).factory("ApplicationError",["$log","$location","$rootScope",function(b,c){function d(e,f){return!this instanceof d?new d(e,f):(f||(f=!1),Error.apply(this,arguments),this.name="ApplicationError",this.type=e,this.message=e||"unknown-error",(a.ga||angular.noop)("send","exception",{exDescription:this.message,exFatal:f}),b.error("ApplicationError - %s",e),f&&c.url("/error/"+e),void $timeout(angular.noop))}return d.prototype=Error.prototype,d.prototype.constructor=d,d}])}(this),function(a){"use strict";angular.module("ysp-services",[]).service("supportsRealTimeCommunication",["$log",function(){return function(){return a.util.supports.audioVideo&&a.util.supports.data?!0:!1}}]).service("peer",["$log","main_host","peer_server_port","ApplicationError","$timeout","$interval","$rootScope",function(a,b,c,d,e,f,g){var h=!1,i=!1,j=new Peer({host:b,port:c,path:"/peers",secure:!0});return j.on("open",function(b){a.debug("peer: main peer connection open (%s)",b),h?g.$broadcast("peer:reconnect"):h=!0}),j.on("close",function(){a.debug("peer: main peer connection closed")}),j.on("error",function(b){if("network"==b.type){if(i)return;i=!0,a.debug("peer: lost connection to signaling server");var c=0,e=f(function(){return c>=20?(a.debug("peer: giving up on reconnecting"),void f.cancel(e)):(c++,a.debug("peer: attempting to reconnect (attempt: %d)",c),void j.reconnect())},1e3);return void j.once("open",function(){i=!1,f.cancel(e),a.debug("peer: reconnected!!")})}a.error("peer: %s",b.type,b);var g={"browser-incompatible":!1,"invalid-id":!1,"invalid-key":!1,"unavailable-id":!1,"ssl-unavailable":!0,"server-disconnected":!1,"server-error":!0,"socket-error":!0,"socket-closed":!0};return new d(b.type,g[b.type]||!1)}),j.on("connection",function(){a.debug("peer: incoming connection")}),j.on("call",function(){a.debug("peer: incoming call")}),j}]).service("_socket",["$log","main_host","ApplicationError",function(a,b,c){var d=io.connect("https://"+b,{path:"/coordinator"});return d.on("error",function(){return new c("socket-io-error",!0)}),d.on("disconnect",function(){a.debug("[_socket] - disconnected!")}),d.on("reconnect",function(){a.debug("[_socket] - reconnected!")}),d}]).factory("coordinator",["$log","_socket","ApplicationError","peer","$rootScope",function(a,b,c,d,e){function f(a,c){b.emit("room_exists",a,c||angular.noop)}function g(e){a.debug("coordinator: advertising peer_id to coordinator...");var f=function(b){return b?new c(b,!0):(a.debug("coordinator: peer_id successfully advertised..."),k=!0,l.emit("ready"),void(e||angular.noop)())};b.connected?b.emit("peer_id",d.id,f):b.once("connect",function(){b.emit("peer_id",d.id,f)})}function h(c,d){if(!k)throw new Error("Must publish peer_id before joining room");b.emit("join_room",c,function(b,e){l.emit("join"),a.debug("coordinator: joined room (%s)",c),(d||angular.noop).call(this,b,e)})}function i(a){k&&b.emit("leave_room",a)}function j(){return k}var k=!1,l=new EventEmitter;return b.on("peer_left",function(a){l.emit("peer_left",a)}),b.on("disconnect",function(){k=!1}),b.on("reconnect",function(){var b=function(){a.debug("coordinator: everything back online"),k=!0};if(d.disconnected)var c=e.$on("peer:reconnect",function(){c(),g(b)});else g(b)}),l.room_exists=f,l.advertise_peer_id=g,l.join_room=h,l.leave_room=i,l.isReady=j,l}]).factory("PeerWrapper",["$log","peer","GumService","$random","$interval","$timeout",function(a,b,c,d,e,f){function g(d,e,f){var g=this,h=0;this.id=d,this.waiting_cbs={},this.dc=e||b.connect(d),this.mc=f||b.call(d,c.getMediaStream()),this.ms=null,this.mc.on("stream",function(b){a.debug("peer-mc(%s) 'stream' event",g.id),g.ms=b,g.emit("stream",b)}),this.mc.on("error",function(b){a.error("peer-mc(%s) error: ",g.id,b),g.emit("error-mc",b)}),this.dc.on("data",function(a){if(h=0,"object"==typeof a){if("event"==a.type){if(a.cb_id)var b=function(){var b={type:"cb",cb_id:a.cb_id},c=Array.prototype.slice.call(arguments);b.args=c,g.dc.send(b)};var c=a.args||[];c.push(b||angular.noop),c.unshift(a.event_name),g.emit.apply(g,c)}"cb"==a.type&&((g.waiting_cbs[a.cb_id]||angular.noop).apply(g,a.args),delete g.waiting_cbs[a.cb_id]),"heartbeat"==a.type&&g.dc.send({type:"heartbeat_reply",hb_id:a.hb_id}),"message"==a.type&&g.emit("message",a.content)}g.emit("data",a)}),this.dc.on("open",function(){a.debug("peer-dc(%s) open",g.id),g.emit("open")}),this.dc.on("close",function(){a.debug("peer-dc(%s) close",g.id),g.emit("close",g.id)}),this.dc.on("error",function(b){h+=1,a.error("peer-dc(%s)",g.id),g.emit("error-dc",b),h>10&&g.close()})}var h={event:function(){var a={},b=Array.prototype.slice.call(arguments);if(a.type="event",a.event_name=b.shift(),"function"==typeof b[b.length-1]){var c=b.pop(),e=d.string(20);this.waiting_cbs[e]=c,a.cb_id=e}a.args=b,this.dc.send(a)},message:function(a){var b={};b.type="message",b.content=a,this.dc.send(b)}};return g.prototype=_.clone(EventEmitter.prototype),g.forgeFromConnections=function(a,b){return b.answer(c.getMediaStream()),new g(a.peer,a,b)},g.prototype.send=function(){var a=this,b=Array.prototype.slice.call(arguments),c=b.shift();if(!h[c])throw new Error("Invalid Sender!");h[c].apply(a,b)},g.prototype.close=_.once(function(){var b=this;a.debug("close called..."),this.mc.close(),this.dc.close(),this.emit("close",this.id),f(function(){b.removeAllListeners(),b.dc.removeAllListeners(),b.mc.removeAllListeners()},500)}),g}]).service("GumService",["$log","$rootScope","ApplicationError",function(a,b,c){function d(){}var e=null,f=!1;d.prototype=_.clone(EventEmitter.prototype),d.prototype.invoke=function(){var a=this;if(!_.isFunction(getUserMedia))return new c("browser-incompatible");if(e&&f)throw new Error("Gum already invoked!");getUserMedia({video:!0,audio:!0},function(b){e=b,f=!0,a.emit("active",e)},function(b){f=!1,a.emit("error",b)})},d.prototype.revoke=function(){e&&e.stop(),f=!1,self.emit("inactive")},d.prototype.getMediaStream=function(){return e},d.prototype.isInvoked=function(a){return(a||angular.noop).call(this,null,f),f};var g=new d;return g.on("error",function(){return new c("no-webcam",!0)}),g}]).service("$random",["$log",function(){function a(a){a=a||15;for(var b=[],c="abcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b.push(c.charAt(Math.round(Math.random()*c.length)));return b.join("")}function b(a,b){return a=a||1,b=b||0,Math.round(Math.random()*(a-b)+b)}this.string=a,this.integer=b}])}(this);