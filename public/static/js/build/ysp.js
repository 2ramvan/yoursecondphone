!function(){"use strict";angular.module("ysp-controllers",["ngSanitize"]).controller("ErrorCtrl",["$log","$scope","$routeParams","peer_server_port","$sce",function(a,b,c,d,e){function f(){return e.trustAsHtml("Your Second Phone is unable to communicate with the server. This is probably because your firewall is blocking access to port <b>"+d+"</b>. These are vital to <b>Your Second Phone</b> working.")}var g={"no-webcam":"Your Second Phone was denied access to the webcam, or their is not one available!","server-error":f("server-error"),"browser-incompatible":'Your browser is not capable of making video calls, please use the latest version of <a target="_blank" href="https://www.google.com/chrome">Google Chrome</a>, <a target="_blank" href="https://www.mozilla.org/firefox">Firefox</a> or <a target="_blank" href="http://www.opera.com/">Opera</a>',"ssl-unavailable":"An error was encountered while attempting to establish a secure connection with the server.","socket-error":f("socket-error"),"socket-io-error":f("socket-io-error"),"timed-out":f("timed-out"),"room-full":"There are already 3 people in this room, which is the limit for rooms."};b.error_id=c.err_type,b.error_description=g[b.error_id]||"An unknown error has occured."}]).controller("RootCtrl",["$log","$scope","GumService","$random","$location","supportsRealTimeCommunication","coordinator","ApplicationError","$timeout",function(a,b,c,d,e,f,g,h,i){b.current_step=0,b.current_step=f()?1:-1,b.error_message="",b.room_name="",b.valid_room_name=!0,b.$watch("room_name",function(a){return""===a?void(b.valid_room_name=!0):void(b.valid_room_name=/^\w(\w|-){1,30}$/.test(a))}),b.loading_gum=!1,b.initGum=function(){b.loading_gum=!0,c.invoke().then(function(){b.current_step+=1,i(angular.noop)},function(){return new h("no-webcam",!0)})["finally"](function(){b.loading_gum=!1})},b.loading_room=!1,b.error_message="",b.launchRoom=function(){b.loading_room=!0,a.debug("Launching room... %s",b.room_name),b.valid_room_name&&""!==b.room_name||(b.room_name=d.string(10)),g.room_exists(b.room_name,function(a){b.loading_room=!1,a?(b.error_message="Sorry, that room name is already taken.",i(angular.noop),i(function(){b.error_message=""},5e3)):(e.path("/"+b.room_name),i(angular.noop))})}}]).controller("RoomCtrl",["$q","$timeout","$log","$scope","GumService","$location","$routeParams","coordinator","ApplicationError","PeerWrapper","peer","fullscreen","$random","$rootScope","supportsRealTimeCommunication",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(a){d.messages.push(a),n.$broadcast("ysp:message")}return o()?(d.room_id=g.room_id,d.room_link="http://ysp.im/#/"+g.room_id,d.peers=[],d.messages=[],d.draft="",d.showMessages=!0,d.isFullscreen=!1,d.getColumnSize=function(){var a=["col-md-12","col-md-12","col-md-6"];return a[d.peers.length]},d.goFullscreen=function(){l.request(document.querySelector("div#all-streams")),b(angular.noop)},d.sendMessage=function(){d.draft&&d.peers.length&&async.each(d.peers,function(a,b){a.send("message",d.draft),b(null)},function(){p({from:k.id,content:d.draft,time_received:new Date}),d.draft="",c.debug("Message sent!")})},$(document).on(l.raw.fullscreenchange,function(){b(angular.noop)}),n.$on("$routeChangeStart",function(){h.leave_room(g.room_id),h.removeAllListeners(),$(document).off(l.raw.fullscreenchange)}),d.$watch(function(){return l.isFullscreen},function(a){d.isFullscreen=a}),d.$on("peer:reconnect",function(){h.once("ready",function(){h.join_room(d.room_id)})}),void a.all([e.invoke(),h.promiseUntilReady()]).then(function(){return h.join_room(d.room_id)}).then(function(a){function e(a){do a.color_code=i[m.integer(4)];while(_.contains(l,a.color_code));l.push(a.color_code),a.once("close",function(e){var f=l.indexOf(a.color_code);l.splice(f,1),c.debug("peer(%s) closed, pruning...",e),d.peers=d.peers.filter(function(a){return a.id!==e}),b(angular.noop)}),a.on("message",function(c){var e={};e.color_code=a.color_code,e.content=c,e.time_received=new Date,e.from=a.id,p(e),d.showMessages=!0,b(angular.noop)}),d.peers.push(a),b(angular.noop)}var f={},g={};k.on("call",function(a){if(g.hasOwnProperty(a.peer)){c.debug("mc(%s) arrived!",a.peer);var b=g[a.peer];delete g[a.peer];var d=j.forgeFromConnections(b,a);e(d)}else c.debug("mc(%s) received before dc, waiting...",a.peer),f[a.peer]=a}),k.on("connection",function(a){if(f.hasOwnProperty(a.peer)){c.debug("dc(%s) arrived!",a.peer);var b=f[a.peer];delete f[a.peer];var d=j.forgeFromConnections(a,b);e(d)}else c.debug("dc(%s) received before mc, waiting...",a.peer),g[a.peer]=a});var i=["green","blue","purple","orange","red"],l=[];h.on("peer_left",function(a){c.debug("[RoomCtrl] - coordinator said that (%s) left",a);var e=_.find(d.peers,{id:a});if(e){e.close();var f=l.indexOf(e.color_code);f>=0&&l.splice(f,1),d.peers=d.peers.filter(function(b){return b.id!==a}),c.debug("[RoomCtrl] - successfully removed %s",a)}b(angular.noop)}),a.forEach(function(a){var b=new j(a);e(b)})})["catch"](function(a){return new i(a,!0)})):new i("browser-incompatible",!0)}])}(this),function(){"use strict";angular.module("ysp-directives",[]).directive("pinToBottom",["$log","$rootScope","$timeout",function(a,b,c){return{restrict:"C",link:function(a,d){d=d[0],b.$on("ysp:message",function(){c(function(){$(d).scrollTop(d.scrollHeight+200)},75)})}}}]).directive("peer",["$log",function(){return{restrict:"E",scope:{peer:"=info"},link:function(a,b){var c=b.children()[0];a.peer.ms?attachMediaStream(c,a.peer.ms):a.peer.once("stream",function(){attachMediaStream(c,a.peer.ms)})},template:"<video autoplay class='peer-window'></video><div class='peer-color' ng-class='peer.color_code'></div>"}}]).directive("mirror",["$log","GumService",function(a,b){return{restrict:"E",link:function(a,c){var d=c.children()[0];b.getMediaStream()?attachMediaStream(d,b.getMediaStream()):b.invoke(),a.$watch(function(){return b.getMediaStream()},function(a){a?(attachMediaStream(d,a),$(c).removeClass("inactive")):$(c).addClass("inactive")})},template:"<video autoplay id='mirror' muted='muted'></video><div class='cf'></div>"}}])}(this),function(a){"use strict";a.$debug=function(b){_.isBoolean(b)&&sessionStorage&&(sessionStorage.debug=b,a.location&&_.isFunction(location.reload)&&location.reload())},angular.module("ysp",["ysp-services","ysp-controllers","ysp-directives","ngRoute","ngSanitize"]).constant("main_host","yoursecondphone.co").constant("peer_server_port",parseInt(window.location.port,10)||443).value("fullscreen",screenfull).config(["$logProvider",function(a){a.debugEnabled(!!sessionStorage&&"true"===sessionStorage.debug)}]).config(["$routeProvider",function(a){a.when("/",{controller:"RootCtrl",templateUrl:"/static/views/root.html"}),a.when("/error/:err_type",{controller:"ErrorCtrl",templateUrl:"/static/views/error.html"}),a.when("/:room_id",{controller:"RoomCtrl",templateUrl:"/static/views/room.html"}),a.otherwise({redirectTo:"/"})}]).run(["$log","peer","coordinator","ApplicationError","$interval","$rootScope",function(a,b,c,d,e,f){b.open?c.advertise_peer_id():b.once("open",function(){c.advertise_peer_id()}),_.isObject(navigator)&&_.isBoolean(navigator.onLine)&&(a.debug("observing online state"),e(function(){f.navOnline=navigator.onLine},50))}]).factory("ApplicationError",["$log","$location","$rootScope","$timeout",function(b,c,d,e){function f(d,g){return!this instanceof f?new f(d,g):(g||(g=!1),Error.apply(this,arguments),this.name="ApplicationError",this.type=d,this.message=d||"unknown-error",(a.ga||angular.noop)("send","exception",{exDescription:this.message,exFatal:g}),b.error("ApplicationError - %s",d),g&&c.url("/error/"+d),void e(angular.noop))}return f.prototype=Error.prototype,f.prototype.constructor=f,f}])}(this),function(a){"use strict";angular.module("ysp-services",[]).service("supportsRealTimeCommunication",["$log",function(){return function(){return a.util.supports.audioVideo&&a.util.supports.data?!0:!1}}]).service("peer",["$log","main_host","peer_server_port","ApplicationError","$timeout","$interval","$rootScope",function(a,b,c,d,e,f,g){var h=!1,i=!1,j=new Peer({host:b,port:c,path:"/peers",secure:!0});return j.on("open",function(b){a.debug("peer: main peer connection open (%s)",b),h?g.$broadcast("peer:reconnect"):h=!0}),j.on("close",function(){a.debug("peer: main peer connection closed")}),j.on("error",function(b){if("network"===b.type){if(i)return;i=!0,g.disconnected=!0,a.debug("peer: lost connection to signaling server");var c=0,e=f(function(){return c>=20?(a.debug("peer: giving up on reconnecting"),void f.cancel(e)):(c++,a.debug("peer: attempting to reconnect (attempt: %d)",c),void j.reconnect())},1e3);return void j.once("open",function(){i=!1,g.disconnected=!1,f.cancel(e),a.debug("peer: reconnected!!")})}a.error("peer: %s",b.type,b);var h={"browser-incompatible":!1,"invalid-id":!1,"invalid-key":!1,"unavailable-id":!1,"ssl-unavailable":!0,"server-disconnected":!1,"server-error":!0,"socket-error":!0,"socket-closed":!0};return new d(b.type,h[b.type]||!1)}),j.on("connection",function(){a.debug("peer: incoming connection")}),j.on("call",function(){a.debug("peer: incoming call")}),j}]).service("_socket",["$log","main_host","ApplicationError",function(a,b,c){var d=io.connect("https://"+b,{path:"/coordinator"});return d.on("error",function(a){return console.error("socket-io-error",a),new c("socket-io-error",!0)}),d.on("disconnect",function(){a.debug("[_socket] - disconnected!")}),d.on("reconnect",function(){a.debug("[_socket] - reconnected!")}),d}]).factory("coordinator",["$log","_socket","ApplicationError","peer","$rootScope","$q","$timeout",function(a,b,c,d,e,f,g){function h(a,c){b.emit("room_exists",a,c||angular.noop)}function i(e){a.debug("coordinator: advertising peer_id to coordinator...");var f=function(b){return b?new c(b,!0):(a.debug("coordinator: peer_id successfully advertised..."),n=!0,o.emit("ready"),void(e||angular.noop)())};b.connected?b.emit("peer_id",d.id,f):b.once("connect",function(){b.emit("peer_id",d.id,f)})}function j(c){return f(function(d,e){n?b.emit("join_room",c,function(b,f){return b?e(b):(a.debug("coordinator: joined room (%s)",c),void d(f))}):e("no-peer-id")})}function k(a){n&&b.emit("leave_room",a)}function l(){return n}function m(){return f(function(a,b){n?a():o.once("ready",a),g(function(){o.removeListeners("ready",a),b("timed-out")},5e3)})}var n=!1,o=new EventEmitter;return b.on("peer_left",function(a){o.emit("peer_left",a)}),b.on("disconnect",function(){n=!1}),b.on("reconnect",function(){var b=function(){a.debug("coordinator: everything back online"),n=!0};if(d.disconnected)var c=e.$on("peer:reconnect",function(){c(),i(b)});else i(b)}),o.room_exists=h,o.advertise_peer_id=i,o.join_room=j,o.leave_room=k,o.isReady=l,o.promiseUntilReady=m,o}]).factory("PeerWrapper",["$log","peer","GumService","$random","$interval","$timeout",function(a,b,c,d,e,f){function g(d,e,f){var g=this,h=0;this.id=d,this.waiting_cbs={},this.dc=e||b.connect(d),this.mc=f||b.call(d,c.getMediaStream()),this.ms=null,this.mc.on("stream",function(b){a.debug("peer-mc(%s) 'stream' event",g.id),g.ms=b,g.emit("stream",b)}),this.mc.on("error",function(b){a.error("peer-mc(%s) error: ",g.id,b),g.emit("error-mc",b)}),this.dc.on("data",function(a){if(h=0,"object"==typeof a){if("event"===a.type){if(a.cb_id)var b=function(){var b={type:"cb",cb_id:a.cb_id},c=Array.prototype.slice.call(arguments);b.args=c,g.dc.send(b)};var c=a.args||[];c.push(b||angular.noop),c.unshift(a.event_name),g.emit.apply(g,c)}"cb"===a.type&&((g.waiting_cbs[a.cb_id]||angular.noop).apply(g,a.args),delete g.waiting_cbs[a.cb_id]),"heartbeat"===a.type&&g.dc.send({type:"heartbeat_reply",hb_id:a.hb_id}),"message"===a.type&&g.emit("message",a.content)}g.emit("data",a)}),this.dc.on("open",function(){a.debug("peer-dc(%s) open",g.id),g.emit("open")}),this.dc.on("close",function(){a.debug("peer-dc(%s) close",g.id),g.emit("close",g.id)}),this.dc.on("error",function(b){h+=1,a.error("peer-dc(%s)",g.id),g.emit("error-dc",b),h>10&&g.close()})}var h={event:function(){var a={},b=Array.prototype.slice.call(arguments);if(a.type="event",a.event_name=b.shift(),"function"==typeof b[b.length-1]){var c=b.pop(),e=d.string(20);this.waiting_cbs[e]=c,a.cb_id=e}a.args=b,this.dc.send(a)},message:function(a){var b={};b.type="message",b.content=a,this.dc.send(b)}};return g.prototype=_.clone(EventEmitter.prototype),g.forgeFromConnections=function(a,b){return b.answer(c.getMediaStream()),new g(a.peer,a,b)},g.prototype.send=function(){var a=this,b=Array.prototype.slice.call(arguments),c=b.shift();if(!h[c])throw new Error("Invalid Sender!");h[c].apply(a,b)},g.prototype.close=_.once(function(){var b=this;a.debug("close called..."),this.mc.close(),this.dc.close(),this.emit("close",this.id),f(function(){b.removeAllListeners(),b.dc.removeAllListeners(),b.mc.removeAllListeners()},500)}),g}]).service("GumService",["$log","$rootScope","ApplicationError","$q",function(a,b,c,d){var e=null,f=!1;this.invoke=function(){return _.isFunction(getUserMedia)?d(function(a,c){return e&&f?a(e):void getUserMedia({video:!0,audio:!0},function(c){b.$broadcast("gum:invoke",c),e=c,f=!0,a(e)},function(){b.$broadcast("gum:error","no-webcam"),c("no-webcam")})}):d.reject("browser-incompatible")},this.revoke=function(){e&&e.stop(),e=null,f=!1,b.$broadcast("gum:revoke")},this.getMediaStream=function(){return e}}]).service("$random",["$log",function(){function a(a){a=a||15;for(var b=[],c="abcdefghijklmnopqrstuvwxyz0123456789",d=0;a>d;d++)b.push(c.charAt(Math.round(Math.random()*c.length)));return b.join("")}function b(a,b){return a=a||1,b=b||0,Math.round(Math.random()*(a-b)+b)}this.string=a,this.integer=b}])}(this);