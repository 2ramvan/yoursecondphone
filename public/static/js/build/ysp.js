!function(){"use strict";angular.module("ysp-controllers",["ngStorage","ngSanitize","Scope.safeApply"]).controller("ErrorCtrl",["$log","$scope","$routeParams",function(a,b,c){var d={"no-webcam":"Your Second Phone was denied access to the webcam!","server-error":"Your Second Phone is unable to communicate with the server. Please try again in a few minutes.","browser-incompatible":"Your browser is not capable of making video calls, please use the latest version of <a target='_blank' href='https://www.google.com/chrome'>Google Chrome</a>, <a target='_blank' href='https://www.mozilla.org/firefox'>Firefox</a> or <a target='_blank' href='http://www.opera.com/'>Opera</a>","unavailable-id":"The conversation ID you were attempting to use is not available."};b.error_id=d.hasOwnProperty(c.err_type)?c.err_type:"unknown-error",b.error_description=d[b.error_id]||"An unknown error has occured."}]).controller("RootCtrl",["$log","$scope","GumService","chance","$location","$localStorage",function(a,b,c,d,e){b.current_step=1,b.room_name="",b.valid_room_name=!0,b.$watch("room_name",function(a){return""===a?void(b.valid_room_name=!0):void(b.valid_room_name=a.match(/^\w(\w|-){1,30}$/))}),b.initGum=function(){c.once("active",function(){b.current_step+=1,b.$safeApply()}),c.invoke()},b.launchRoom=function(){a.debug("Launching room... %s",b.room_name),b.valid_room_name&&""!=b.room_name||(b.room_name=d.word({length:8})),e.path("/"+b.room_name),b.$safeApply()}}]).controller("RoomCtrl",["$log","$scope","GumService","$location","$routeParams","$localStorage","negotiator","ApplicationError","PeerWrapper","peer","fullscreen","chance","$rootScope",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){b.messages.push(a),m.$broadcast("ysp:message")}b.room_id=e.room_id,b.room_link="http://ysp.im/#/"+e.room_id,b.peers=[],b.messages=[],b.draft="",b.showMessages=!0,b.isFullscreen=!1,b.getNumPeers=function(){var a=["zero","one","two"];return a[b.peers.length]},b.getColumnSize=function(){var a=["large-12","large-12","large-6"];return a[b.peers.length]},b.goFullscreen=function(){k.request(document.querySelector("div#all-streams")),b.$safeApply()},b.sendMessage=function(){b.draft&&b.peers.length&&async.each(b.peers,function(a,c){a.send("message",b.draft),c(null)},function(){n({from:j.id,content:b.draft,time_received:new Date}),b.draft="",a.debug("Message sent!")})},$(document).on(k.raw.fullscreenchange,function(){b.$safeApply()}),m.$on("$routeChangeStart",function(){g.leave_room(e.room_id),g.removeAllListeners(),$(document).off(k.raw.fullscreenchange)}),b.$watch(function(){return k.isFullscreen},function(a){b.isFullscreen=a}),async.waterfall([function(a){async.parallel([function(a){return c.isInvoked()?a(null):(c.once("active",function(){return a(null)}),void c.invoke())},function(a){g.isReady()?a(null):g.once("ready",function(){a(null)})}],function(){a(null)})},function(a){g.join_room(b.room_id,a)}],function(c,d){function e(c){do c.color_code=l.pick(m);while(_.contains(o,c.color_code));o.push(c.color_code),c.once("close",function(d){var e=o.indexOf(c.color_code);o.splice(e,1),a.debug("peer(%s) closed, pruning...",d),b.peers=b.peers.filter(function(a){return a.id!=d}),b.$safeApply()}),c.on("message",function(a){var d={};d.color_code=c.color_code,d.content=a,d.time_received=new Date,d.from=c.id,n(d),b.showMessages=!0,b.$safeApply()}),b.peers.push(c),b.$safeApply()}if(c)return new h(c);var f={},k={};j.on("call",function(b){if(k.hasOwnProperty(b.peer)){a.debug("mc(%s) arrived!",b.peer);var c=k[b.peer];delete k[b.peer];var d=i.forgeFromConnections(c,b);e(d)}else a.debug("mc(%s) received before dc, waiting...",b.peer),f[b.peer]=b}),j.on("connection",function(b){if(f.hasOwnProperty(b.peer)){a.debug("dc(%s) arrived!",b.peer);var c=f[b.peer];delete f[b.peer];var d=i.forgeFromConnections(b,c);e(d)}else a.debug("dc(%s) received before mc, waiting...",b.peer),k[b.peer]=b});var m=["green","blue","purple","orange","red"],o=[];g.on("peer_left",function(a){b.peers.forEach(function(b,c,d){b.id==a&&(b.close(),d.splice(c,1))})}),g.on("reconnect",function(){g.join_room(b.room_id)}),d.forEach(function(a){var b=new i(a);e(b)})})}])}(this),function(){"use strict";angular.module("ysp-directives",[]).directive("pinToBottom",["$log","$rootScope","$timeout",function(a,b,c){return{restrict:"C",link:function(a,d){d=d[0],b.$on("ysp:message",function(){c(function(){$(d).scrollTop(d.scrollHeight+200)},75)})}}}]).directive("peer",["$log",function(){return{restrict:"E",scope:{peer:"=info"},link:function(a,b){var c=b.children()[0];a.peer.ms?attachMediaStream(c,a.peer.ms):a.peer.once("stream",function(){attachMediaStream(c,a.peer.ms)})},template:"<video autoplay class='peer_window'></video><div class='peer_color' ng-class='peer.color_code'></div>"}}]).directive("mirror",["$log","GumService",function(a,b){return{restrict:"E",link:function(a,c){var d=c.children()[0];b.isInvoked()&&attachMediaStream(d,b.getMediaStream()),b.on("active",function(a){attachMediaStream(d,a),$(c).removeClass("inactive")}),b.on("inactive",function(){$(c).addClass("inactive")})},template:"<video autoplay id='mirror' muted='muted'></video><div class='cf'></div>"}}])}(this),function(a){"use strict";angular.module("ysp",["ysp-services","ysp-controllers","ysp-directives","ngRoute","ngSanitize","ngStorage","Scope.safeApply"]).constant("negotiator_host","negotiate.ysp.im").constant("negotiator_port",9091).constant("signaler_port",9090).value("fullscreen",screenfull).config(["$routeProvider",function(a){a.when("/",{controller:"RootCtrl",templateUrl:"/static/views/root.html"}),a.when("/error/:err_type",{controller:"ErrorCtrl",templateUrl:"/static/views/error.html"}),a.when("/:room_id",{controller:"RoomCtrl",templateUrl:"/static/views/room.html"}),a.otherwise({redirectTo:"/"})}]).run(["$log","peer","negotiator","ApplicationError",function(b,c,d,e){return a.util.supports.audioVideo&&a.util.supports.data?(b.debug("Browser supports all necessary components"),void(c.open?d.advertise_peer_id():c.on("open",function(){d.advertise_peer_id()}))):new e("browser-incompatible")}]).factory("ApplicationError",["$log","$location","$rootScope",function(a,b,c){function d(e){return!this instanceof d?new d(e):(Error.call(this,arguments),this.name="ApplicationError",this.type=e,this.message=e||"unknown-error",a.error("ApplicationError - %s",e),b.url("/error/"+e),void c.$safeApply())}return d.prototype=new Error,d.prototype.constructor=d,d}])}(this),function(){"use strict";angular.module("ysp-services",["ngStorage"]).service("peer",["$log","negotiator_host","signaler_port","ApplicationError",function(a,b,c,d){var e=new Peer({host:b,port:c,secure:!0});return e.on("open",function(b){a.debug("peer: main peer connection open (%s)",b)}),e.on("close",function(){a.debug("peer: main peer connection closed")}),e.on("error",function(b){a.error("peer: Error! - ",b.type,b),new d(b.type)}),e.on("connection",function(){a.debug("peer: incoming connection")}),e.on("call",function(){a.debug("peer: incoming call")}),e}]).service("_socket",["negotiator_host","negotiator_port",function(a,b){return io.connect("https://"+a+":"+b)}]).factory("negotiator",["$log","_socket","ApplicationError","peer",function(a,b,c,d){function e(e){a.debug("negotiator: advertising peer_id to negotiator...");var f=function(b){return b?new c(b):(a.debug("negotiator: peer_id successfully advertised..."),i=!0,j.emit("ready"),void(e||angular.noop)())};b.socket.connected?b.emit("peer_id",d.id,f):b.once("connect",function(){b.emit("peer_id",d.id,f)})}function f(c,d){if(!i)throw new Error("Must publish peer_id before joining room");b.emit("join_room",c,function(b,e){j.emit("join"),a.debug("negotiator: joined room (%s)",c),(d||angular.noop).call(this,b,e)})}function g(a){i&&b.emit("leave_room",a)}function h(){return i}var i=!1,j=new EventEmitter;return b.on("peer_left",function(a){j.emit("peer_left",a)}),b.on("disconnect",function(){i=!1}),b.on("reconnect",function(){e(function(){j.emit("reconnect")})}),j.advertise_peer_id=e,j.join_room=f,j.leave_room=g,j.isReady=h,j}]).factory("PeerWrapper",["$log","peer","GumService","chance","$interval","$timeout","negotiator",function(a,b,c,d,e,f){function g(d,e,f){var g=this,h=0;this.id=d,this.waiting_cbs={},this.dc=e||b.connect(d),this.mc=f||b.call(d,c.getMediaStream()),this.ms=null,this.mc.on("stream",function(b){a.debug("peer-mc(%s) 'stream' event",g.id),g.ms=b,g.emit("stream",b)}),this.mc.on("error",function(b){a.error("peer-mc(%s) error: ",g.id,b),g.emit("error-mc",b)}),this.dc.on("data",function(a){if(h=0,"object"==typeof a){if("event"==a.type){if(a.cb_id)var b=function(){var b={type:"cb",cb_id:a.cb_id},c=Array.prototype.slice.call(arguments);b.args=c,g.dc.send(b)};var c=a.args||[];c.push(b||angular.noop),c.unshift(a.event_name),g.emit.apply(g,c)}"cb"==a.type&&((g.waiting_cbs[a.cb_id]||angular.noop).apply(g,a.args),delete g.waiting_cbs[a.cb_id]),"heartbeat"==a.type&&g.dc.send({type:"heartbeat_reply",hb_id:a.hb_id}),"message"==a.type&&g.emit("message",a.content)}g.emit("data",a)}),this.dc.on("open",function(){a.debug("peer-dc(%s) open",g.id),g.emit("open")}),this.dc.on("close",function(){a.debug("peer-dc(%s) close",g.id),g.emit("close",g.id)}),this.dc.on("error",function(b){h+=1,a.error("peer-dc(%s)",g.id),g.emit("error-dc",b),h>10&&g.close()})}var h={event:function(){var a={},b=Array.prototype.slice.call(arguments);if(a.type="event",a.event_name=b.shift(),"function"==typeof b[b.length-1]){var c=b.pop(),e=d.string({length:20,pool:"abcdefghijklmnopqrstuvwxyz"});this.waiting_cbs[e]=c,a.cb_id=e}a.args=b,this.dc.send(a)},message:function(a){var b={};b.type="message",b.content=a,this.dc.send(b)}};return g.prototype=_.clone(EventEmitter.prototype),g.forgeFromConnections=function(a,b){return b.answer(c.getMediaStream()),new g(a.peer,a,b)},g.prototype.send=function(){var a=this,b=Array.prototype.slice.call(arguments),c=b.shift();if(!h[c])throw new Error("Invalid Sender!");h[c].apply(a,b)},g.prototype.close=_.once(function(){var b=this;a.debug("close called..."),this.mc.close(),this.dc.close(),this.emit("close",this.id),f(function(){b.removeAllListeners(),b.dc.removeAllListeners(),b.mc.removeAllListeners()},500)}),g}]).service("GumService",["$log","$rootScope","ApplicationError",function(a,b,c){function d(){}var e=null,f=!1;d.prototype=_.clone(EventEmitter.prototype),d.prototype.invoke=function(){var a=this;if(!_.isFunction(getUserMedia))return new c("browser-incompatible");if(e&&f)throw new Error("Gum already invoked!");getUserMedia({video:!0,audio:!0},function(b){e=b,f=!0,a.emit("active",e)},function(b){f=!1,a.emit("error",b)})},d.prototype.revoke=function(){e&&e.stop(),f=!1,self.emit("inactive")},d.prototype.getMediaStream=function(){return e},d.prototype.isInvoked=function(a){return(a||angular.noop).call(this,null,f),f};var g=new d;return g.on("error",function(){return new c("no-webcam")}),g}]).service("chance",[function(){return new Chance}])}(this);